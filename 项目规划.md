# Cloudflare DNS 管理系统 - 项目规划文档

## 项目概述

一个基于 React + Node.js 的 Cloudflare DNS 管理 Web 应用，支持用户登录认证、域名管理、DNS 记录快速操作、自定义主机名管理和完整的操作日志记录。

---

## 技术栈

### 前端
- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI 组件库**: Material-UI (MUI)
- **状态管理**: React Query (数据获取和缓存)
- **HTTP 客户端**: Axios
- **路由**: React Router v6
- **表单处理**: React Hook Form
- **国际化**: 全中文界面

### 后端
- **运行时**: Node.js 18+
- **框架**: Express + TypeScript
- **数据库**: SQLite (轻量级，适合单服务器部署)
- **ORM**: Prisma (类型安全的数据库访问)
- **认证**: JWT (JSON Web Token)
- **密码加密**: bcrypt
- **API 集成**: Cloudflare SDK (`cloudflare`)
- **缓存**: node-cache (内存缓存)
- **环境变量**: dotenv

---

## 项目结构

```
cf-dns-manager/
├── client/                          # React 前端
│   ├── public/                      # 静态资源
│   ├── src/
│   │   ├── components/              # 可复用组件
│   │   │   ├── Layout/              # 布局组件
│   │   │   ├── DomainList/          # 域名列表
│   │   │   ├── DNSRecordTable/      # DNS 记录表格
│   │   │   ├── QuickAddForm/        # 快速添加表单
│   │   │   └── LogViewer/           # 日志查看器
│   │   ├── pages/                   # 页面组件
│   │   │   ├── Login.tsx            # 登录页
│   │   │   ├── Dashboard.tsx        # 仪表盘
│   │   │   ├── DomainDetail.tsx     # 域名详情
│   │   │   ├── CustomHostnames.tsx  # 自定义主机名
│   │   │   ├── Logs.tsx             # 操作日志
│   │   │   └── Settings.tsx         # 设置页面
│   │   ├── services/                # API 服务
│   │   │   ├── api.ts               # Axios 配置
│   │   │   ├── auth.ts              # 认证相关
│   │   │   ├── domains.ts           # 域名操作
│   │   │   └── dns.ts               # DNS 操作
│   │   ├── hooks/                   # 自定义 Hooks
│   │   ├── utils/                   # 工具函数
│   │   ├── types/                   # TypeScript 类型定义
│   │   ├── App.tsx                  # 根组件
│   │   └── main.tsx                 # 入口文件
│   ├── package.json
│   └── vite.config.ts
│
├── server/                          # Node.js 后端
│   ├── prisma/                      # Prisma 配置
│   │   ├── schema.prisma            # 数据库模型
│   │   └── migrations/              # 数据库迁移
│   ├── src/
│   │   ├── routes/                  # API 路由
│   │   │   ├── auth.ts              # 认证路由
│   │   │   ├── domains.ts           # 域名路由
│   │   │   ├── dns.ts               # DNS 路由
│   │   │   ├── hostnames.ts         # 自定义主机名路由
│   │   │   └── logs.ts              # 日志路由
│   │   ├── services/                # 业务逻辑
│   │   │   ├── cloudflare.ts        # Cloudflare API 封装
│   │   │   ├── auth.ts              # 认证服务
│   │   │   └── logger.ts            # 日志服务
│   │   ├── middleware/              # 中间件
│   │   │   ├── auth.ts              # JWT 验证
│   │   │   ├── errorHandler.ts      # 错误处理
│   │   │   └── logger.ts            # 请求日志
│   │   ├── config/                  # 配置文件
│   │   │   └── index.ts             # 配置管理
│   │   ├── types/                   # TypeScript 类型
│   │   ├── utils/                   # 工具函数
│   │   └── index.ts                 # 入口文件
│   ├── package.json
│   └── tsconfig.json
│
├── .env.example                     # 环境变量示例
├── .gitignore
├── README.md
└── 项目规划.md                      # 本文档
```

---

## 数据库设计

### 用户表 (users)
```prisma
model User {
  id              Int       @id @default(autoincrement())
  username        String    @unique
  email           String    @unique
  password        String    // bcrypt 加密
  cfApiToken      String    // Cloudflare API Token (加密存储)
  cfAccountId     String?   // Cloudflare Account ID
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  logs            Log[]
}
```

### 操作日志表 (logs)
```prisma
model Log {
  id              Int       @id @default(autoincrement())
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  timestamp       DateTime  @default(now())
  action          String    // CREATE, UPDATE, DELETE
  resourceType    String    // DNS, ZONE, HOSTNAME
  domain          String?
  recordName      String?
  recordType      String?   // A, AAAA, CNAME, MX, TXT, etc.
  oldValue        String?   // JSON 格式
  newValue        String?   // JSON 格式
  status          String    // SUCCESS, FAILED
  errorMessage    String?
  ipAddress       String?   // 操作者 IP
}
```

### 缓存表 (可选，用于减少 API 调用)
```prisma
model Cache {
  id              Int       @id @default(autoincrement())
  key             String    @unique
  value           String    // JSON 格式
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
}
```

---

## 核心功能模块

### 1. 用户认证系统

#### 1.1 注册功能
- 用户名、邮箱、密码注册
- Cloudflare API Token 配置（加密存储）
- 可选：Cloudflare Account ID
- 密码强度验证（至少 8 位，包含大小写字母和数字）

#### 1.2 登录功能
- 用户名/邮箱 + 密码登录
- JWT Token 生成（有效期 7 天）
- Refresh Token 机制
- 记住登录状态

#### 1.3 Token 管理
- Cloudflare API Token 加密存储（AES-256）
- Token 验证（启动时检查 Token 有效性）
- Token 更新功能

#### 1.4 安全措施
- 密码 bcrypt 加密（salt rounds: 10）
- JWT 签名验证
- API 请求频率限制
- 登录失败次数限制（5 次后锁定 15 分钟）

---

### 2. 域名管理模块

#### 2.1 域名列表页
**功能：**
- 展示所有 Cloudflare 域名（Zones）
- 显示信息：
  - 域名名称
  - 状态（激活/暂停/待验证）
  - DNS 记录数量
  - 最后更新时间
  - 快速操作按钮
- 搜索功能（域名名称模糊搜索）
- 排序功能（按名称、状态、更新时间）
- 刷新按钮（手动刷新域名列表）

**UI 设计：**
- Material-UI DataGrid 表格
- 状态用彩色标签显示
- 每行右侧有"管理 DNS"按钮

#### 2.2 域名详情页
**功能：**
- 域名基本信息展示
- DNS 记录管理（见下节）
- 域名设置（Name Servers、DNSSEC 状态）

---

### 3. DNS 记录管理模块

#### 3.1 DNS 记录列表
**功能：**
- 表格展示所有 DNS 记录
- 显示字段：
  - 类型（A、AAAA、CNAME、MX、TXT、SRV、CAA 等）
  - 名称（主机名）
  - 内容（IP 地址或目标）
  - TTL（生存时间）
  - 代理状态（Cloudflare 橙色云图标）
  - 优先级（MX、SRV 记录）
  - 操作按钮（编辑、删除）
- 筛选功能（按记录类型筛选）
- 搜索功能（按名称或内容搜索）
- 批量选择和删除

**UI 设计：**
- Material-UI DataGrid
- 代理状态用图标显示（橙色云/灰色云）
- 行内编辑支持

#### 3.2 快速添加 DNS 记录
**功能：**
- 快速添加表单（固定在页面顶部）
- 字段：
  - 记录类型（下拉选择）
  - 名称（输入框，支持 @ 表示根域名）
  - 内容（输入框）
  - TTL（下拉选择：自动、1 分钟、5 分钟、1 小时等）
  - 代理状态（开关按钮）
  - 优先级（MX、SRV 记录显示）
- 回车快速提交
- 表单验证（IP 格式、域名格式等）
- 添加成功后自动清空表单

**UI 设计：**
- Material-UI Card 卡片包裹
- 表单字段横向排列（响应式布局）
- 提交按钮显眼

#### 3.3 批量操作
**功能：**
- 批量导入（CSV/JSON 格式）
- 批量删除（选中多条记录）
- 批量修改 TTL
- 批量开启/关闭代理

#### 3.4 快速模板
**功能：**
- 预设常用配置模板：
  - **基础 Web 服务**：www (A/CNAME)、@ (A)
  - **邮件服务**：mail (A)、MX 记录、SPF (TXT)
  - **CDN 配置**：cdn (CNAME)
  - **验证记录**：_dmarc、_domainkey (TXT)
- 一键应用模板
- 自定义模板保存

---

### 4. 自定义主机名管理

#### 4.1 自定义主机名列表
**功能：**
- 展示所有自定义主机名（Custom Hostnames）
- 显示信息：
  - 主机名
  - SSL 证书状态（待验证/激活/失败）
  - 验证方法（HTTP/TXT/Email）
  - 创建时间
  - 操作按钮
- 添加新主机名
- 删除主机名
- 查看验证详情

**适用场景：**
- SaaS 应用的客户自定义域名
- 白标服务

---

### 5. 操作日志模块

#### 5.1 日志记录
**自动记录的操作：**
- DNS 记录创建、更新、删除
- 域名设置修改
- 自定义主机名操作
- 用户登录/登出
- API Token 更新

**记录内容：**
- 操作时间（精确到秒）
- 操作类型（创建/更新/删除）
- 资源类型（DNS/域名/主机名）
- 域名
- 记录详情（名称、类型、内容）
- 修改前后的值（JSON 格式）
- 操作状态（成功/失败）
- 错误信息（如果失败）
- 操作者 IP 地址

#### 5.2 日志查看页面
**功能：**
- 时间线展示（最新的在上面）
- 筛选功能：
  - 时间范围（今天/最近 7 天/最近 30 天/自定义）
  - 操作类型
  - 资源类型
  - 域名
  - 状态（成功/失败）
- 搜索功能（关键词搜索）
- 分页加载（每页 50 条）
- 失败操作高亮显示（红色背景）
- 导出功能（CSV/JSON）

**UI 设计：**
- Material-UI Timeline 组件
- 每条日志显示图标（根据操作类型）
- 可展开查看详细信息

---

### 6. 设置页面

#### 6.1 账户设置
- 修改用户名
- 修改邮箱
- 修改密码
- 更新 Cloudflare API Token

#### 6.2 系统设置
- 缓存设置（缓存时间、清除缓存）
- 日志保留时间（默认 90 天）
- 界面主题（亮色/暗色）

---

## API 接口设计

### 认证相关

#### POST /api/auth/register
注册新用户
```json
Request:
{
  "username": "admin",
  "email": "admin@example.com",
  "password": "Password123",
  "cfApiToken": "your-cloudflare-api-token",
  "cfAccountId": "optional-account-id"
}

Response:
{
  "success": true,
  "message": "注册成功",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com"
  }
}
```

#### POST /api/auth/login
用户登录
```json
Request:
{
  "username": "admin",
  "password": "Password123"
}

Response:
{
  "success": true,
  "token": "jwt-token-here",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com"
  }
}
```

#### POST /api/auth/logout
用户登出

#### GET /api/auth/me
获取当前用户信息（需要 JWT）

---

### 域名相关

#### GET /api/domains
获取所有域名列表
```json
Response:
{
  "success": true,
  "data": [
    {
      "id": "zone-id",
      "name": "example.com",
      "status": "active",
      "recordCount": 15,
      "updatedAt": "2025-12-10T10:30:00Z"
    }
  ]
}
```

#### GET /api/domains/:zoneId
获取域名详情

---

### DNS 记录相关

#### GET /api/dns/:zoneId/records
获取指定域名的所有 DNS 记录
```json
Response:
{
  "success": true,
  "data": [
    {
      "id": "record-id",
      "type": "A",
      "name": "www.example.com",
      "content": "192.0.2.1",
      "ttl": 3600,
      "proxied": true,
      "priority": null
    }
  ]
}
```

#### POST /api/dns/:zoneId/records
创建 DNS 记录
```json
Request:
{
  "type": "A",
  "name": "www",
  "content": "192.0.2.1",
  "ttl": 3600,
  "proxied": true
}

Response:
{
  "success": true,
  "message": "DNS 记录创建成功",
  "data": { /* 记录详情 */ }
}
```

#### PUT /api/dns/:zoneId/records/:recordId
更新 DNS 记录

#### DELETE /api/dns/:zoneId/records/:recordId
删除 DNS 记录

#### POST /api/dns/:zoneId/records/batch
批量操作 DNS 记录

---

### 自定义主机名相关

#### GET /api/hostnames/:zoneId
获取自定义主机名列表

#### POST /api/hostnames/:zoneId
添加自定义主机名

#### DELETE /api/hostnames/:zoneId/:hostnameId
删除自定义主机名

---

### 日志相关

#### GET /api/logs
获取操作日志
```json
Query Parameters:
- page: 页码（默认 1）
- limit: 每页数量（默认 50）
- startDate: 开始时间
- endDate: 结束时间
- action: 操作类型
- resourceType: 资源类型
- domain: 域名
- status: 状态

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "timestamp": "2025-12-12T10:30:00Z",
      "action": "CREATE",
      "resourceType": "DNS",
      "domain": "example.com",
      "recordName": "www",
      "recordType": "A",
      "newValue": "{\"content\":\"192.0.2.1\"}",
      "status": "SUCCESS"
    }
  ],
  "pagination": {
    "total": 150,
    "page": 1,
    "limit": 50,
    "pages": 3
  }
}
```

#### GET /api/logs/export
导出日志（CSV/JSON）

---

## 安全设计

### 1. 认证安全
- JWT Token 有效期：7 天
- Refresh Token 机制
- Token 存储在 HttpOnly Cookie 中（防止 XSS）
- CSRF Token 保护

### 2. 数据加密
- 用户密码：bcrypt 加密（salt rounds: 10）
- Cloudflare API Token：AES-256 加密存储
- 数据库连接加密

### 3. API 安全
- 所有 API 需要 JWT 验证（除了登录/注册）
- 请求频率限制（Rate Limiting）
  - 登录接口：5 次/分钟
  - DNS 操作：30 次/分钟
  - 查询接口：100 次/分钟
- 输入验证和清理（防止 SQL 注入、XSS）
- CORS 配置（仅允许前端域名）

### 4. 操作安全
- 敏感操作二次确认（批量删除、域名删除）
- 操作日志完整记录
- IP 地址记录

---

## 性能优化

### 1. 缓存策略
- 域名列表缓存：5 分钟
- DNS 记录缓存：2 分钟
- 用户信息缓存：10 分钟
- 手动刷新按钮清除缓存

### 2. 前端优化
- React.lazy 懒加载页面组件
- React Query 自动缓存和重新验证
- 虚拟滚动（大量 DNS 记录时）
- 防抖和节流（搜索、筛选）

### 3. 后端优化
- 数据库索引优化
- 批量操作合并请求
- 异步处理日志写入
- Gzip 压缩响应

---

## 部署方案

### 开发环境
```bash
# 前端
cd client
npm install
npm run dev  # http://localhost:5173

# 后端
cd server
npm install
npx prisma migrate dev  # 初始化数据库
npm run dev  # http://localhost:3000
```

### 生产环境（私有服务器）

#### 1. 服务器要求
- Node.js 18+
- Nginx（反向代理）
- PM2（进程管理）
- 至少 1GB RAM

#### 2. 部署步骤

**后端部署：**
```bash
cd server
npm install --production
npx prisma migrate deploy
npm run build
pm2 start dist/index.js --name cf-dns-api
```

**前端部署：**
```bash
cd client
npm install
npm run build
# 将 dist 目录部署到 Nginx
```

**Nginx 配置：**
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端
    location / {
        root /var/www/cf-dns-manager/client/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 3. 环境变量配置
```env
# .env
NODE_ENV=production
PORT=3000
DATABASE_URL="file:./database.db"
JWT_SECRET="your-super-secret-jwt-key-change-this"
JWT_EXPIRES_IN="7d"
ENCRYPTION_KEY="your-32-character-encryption-key"
CORS_ORIGIN="https://your-domain.com"
```

#### 4. SSL 证书（推荐）
```bash
# 使用 Let's Encrypt
sudo certbot --nginx -d your-domain.com
```

---

## 开发计划

### 第一阶段：基础架构（1-2 天）
- [x] 项目初始化
- [ ] 数据库设计和 Prisma 配置
- [ ] 后端基础框架搭建
- [ ] 前端基础框架搭建
- [ ] 用户认证系统

### 第二阶段：核心功能（3-4 天）
- [ ] 域名列表页面
- [ ] DNS 记录管理
- [ ] 快速添加功能
- [ ] Cloudflare API 集成

### 第三阶段：高级功能（2-3 天）
- [ ] 自定义主机名管理
- [ ] 操作日志系统
- [ ] 批量操作功能
- [ ] 快速模板功能

### 第四阶段：优化和测试（1-2 天）
- [ ] 性能优化
- [ ] 错误处理完善
- [ ] UI/UX 优化
- [ ] 测试和 Bug 修复

### 第五阶段：部署（1 天）
- [ ] 生产环境配置
- [ ] 部署文档编写
- [ ] 上线测试

---

## 后续扩展功能（可选）

### 1. 多用户协作
- 团队管理
- 权限分级（管理员/编辑者/查看者）
- 操作审批流程

### 2. 更多 Cloudflare 功能
- Page Rules 管理
- 防火墙规则管理
- SSL/TLS 设置
- 缓存清除
- 流量分析

### 3. 自动化功能
- 定时任务（自动更新 DNS）
- Webhook 通知
- API 接口（供第三方调用）

### 4. 监控和告警
- DNS 记录变更通知
- SSL 证书过期提醒
- 域名状态监控
- 邮件/Telegram 通知

---

## 技术文档参考

- [Cloudflare API 文档](https://developers.cloudflare.com/api/)
- [Material-UI 文档](https://mui.com/)
- [Prisma 文档](https://www.prisma.io/docs)
- [React Query 文档](https://tanstack.com/query/latest)
- [Express 文档](https://expressjs.com/)

---

## 联系和支持

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- Email: your-email@example.com

---

**最后更新时间：2025-12-12**
